%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Uživatelská příručka}
Tato práce se zabývá implementací již známých algoritmů, je tedy spíše
praktického zaměření. Úmyslně jsem tedy posunul kapitolu s~hlubším popisem
implementovaných algoritmů až za uživatelskou příručku, aby byl čternář při
její četbě již seznámen s~používanými datovými strukturami, strukturou
pravidel, apod.

Tato kapitola vyžaduje alespoň zběžnou znalost programovacího jazyka
Common Lisp, jeho základních datových typů (symbol, seznam) a metod pro
práci s~nimi.

V~kapitole budu občas uvádět v~závorkách a kurzívou názvy některých použitých
tříd či metod. Je to kvůli snadnější orientaci při následné četbě programátorské
dokumentace. Čtenář, který tuto číst nehodlá je může směle přeskakovat.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Použité datové struktury}
Uživatel knihovny Exil (dále jen knihovny) se nejčasteji setká se dvěma datovými
strukturami, jsou to fakta (třída \emph{fact}) a pravidla (třída \emph{rule}).
Fakta znalostní baze mohou být buď jednoduchá (třída \emph{simple-fact}),
specifikovaná prostým seznamem atomů (např. \verb|(on book table)|), či
strukturovaná (třída \emph{template-fact}. Pro použití strukturovaných fakt je
třeba nejdříve definovat šablonu makrem \verb|deftemplate| následovně:
\begin{verbatim}
(deftemplate in (object location (ammount :default 1)))
\end{verbatim}
Volání makra je velice podobné volání vestavěného makra Common lispu
\verb|defclass|, jen neobsahuje seznam tříd, neboť neposkytuje dědičnost.
Prvním parametrem je jméno šablony, dalším pak seznam slotů (pojmenované
části faktu) s~případnými implicitními hodnotami. Specifikace takovéhoto
 strukturovaného faktu pak vypadá takto:
\verb|(in :object fridge :location kitchen)|.

Pozn.: Při opakovaném volání \verb|deftemplate| se stejným jménem šablony
dochází k~přepsání původní definice. Má-li nově definovaná šablona jiné sloty
než šablona původní a existují-li ve znalostní bazi fakta vytvořená pomocí
původní šablony, vzniká nekonzistence. Makro je tedy třeba volat s~rozmyslem.

Kromě fakt se uživatel setká ještě s~tzv. \emph{patterny} (pro neznalost
výstižného českého ekvivalentu se budu držet dobře zažitého výrazu anglického).
Tyto jsou faktům velmi podobné, jen se v~nich mohou vyskytovat proměnné.
Název proměnné v~mé implementaci vždy začíná otazníkem (stejně jako v~systému
CLIPS) a je tedy od běžného atomu jasně patrný. Patterny mohou být, stejně
jako fakta, jednoduché či strukturované. Při snaze použít proměnnou v~popisu
faktu skončí vyhodnocení výrazu chybou.

Odvozovací pravidlo je druhým stavebním kamenem expertního systému. Umožňuje
inferenčnímu mechanismu vyvozovat ze zadaných fakt fakta nová. Pravidlo sestává
ze dvou částí - podmínkek a aktivací. Podmínky určují, za jakých okolností je 
pravidlo splněno fakty znalostní baze a je jej možno zařadit do seznamu pravidel
k~aktivaci (tento seznam budu dále označovat jako \emph{agenda}). Seznam
aktivací je tvořen libovolným počtem lispových výrazů (jež pochopitelně mohou,
a velmi často budou, zahrnovat i knihovnou definované metody a makra), které se
při aktivaci pravidla vyhodnotí. Pravidlo tedy typicky při platnosti nějakých
fakt či neplatnosti jiných přidá do znalostní baze nějaká další fakta, či
některerá z~baze odebere.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Manipulace s~fakty znalostní baze}
K~přidání faktu do znalostní baze souží makro \verb|assert|, přidání tedy
vypadá následovně:
\begin{verbatim}
(assert (on book table))
(assert (in :object fridge :location kitchen))
\end{verbatim}
Při pokusu o~opětované přidání již existujícího faktu se nestane nic.

Odebrání faktu z~baze se provádí makrem \verb|retract| se stejnou syntaxí.
Při pokusu o~odebrání neexistujícího faktu se opět nic nestane.

Posledním makrem z~této skupiny je \verb|modify| to slouží k~modifikaci
faktu (jeho nahrazení jiným) a používá se takto:
\begin{verbatim}
(modify (in :object snack :location fridge)
        (in :object snack :location schoolbag))
\end{verbatim}
Toto makro je ve skutečnosti jen zkratkou pro postupné volání \verb|assert|
a \verb|retract|. Neslouží ani tak k~ušetření zdrojového kódu, jako spíš
ke zčitelnění aktivací pravidla - z~jeho použití je evidentní vztah dvou
faktů.

\subsubsection{Definice skupiny faktů}
Pro pohodlnější práci s~větším množstvím faktů jsem (stejně jako systém
CLIPS) implementoval makro \verb|deffacts|. Volání tohoto makra obsahuje
název skupiny faktů náledovaný jejich seznamem:
\begin{verbatim}
(deffacts stuff-i-ve-got-in-me-fridge
  (in :object coke :location fridge)
  (in :object cheese :location fridge)
  (is-expired cheese)
  (in :object butter :location fridge)
        ...
  )
\end{verbatim}
Takto definovaná fakta se ve znalostní bazi neobjeví hned, nýbrž až po zavolání
makra \verb|reset| (bez parametrů). Toto makro odstraní ze znalostní baze
všechna fakta a poté ji naplní fakty definovanými ve skupinách makrem
\verb|deffacts|. K~pouhému vyčištění znalostní baze slouží makro \verb|clear|
(opět bez parametrů).
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Manipulace s~odvozovacími pravidly}
Definice odvozovacího pravidla se provádí makrem \verb|defrule| a~zahrnuje jméno
pravidla a~seznamy podmínek a~aktivací. Podmínky jsou od aktivací odděleny
symbolem \verb|=>|. Vypadá to tedy nějak takto:
\begin{verbatim}
(defrule find-and-take-green-fruit-to-the-left-of-orange-vegetable
  (green ?x)
  (fruit ?x)
  (orange ?y)
  (vegetable ?y)
  (next-to :left-one ?x :right-one ?y)
=>
  (take ?x)
  (take ?y))
\end{verbatim}
Jak je z~příkladu zřejmé, podmínky pravidel mohou obsahovat proměnné, jde tedy
o~patterny. Podmínky mohou být také negované, pak se ověřuje neexistence
odpovídajícího faktu ve znalostní bazi. Negované podmínky jsou specifikovány
symbolem - (minus) ještě před prvním atomem (či před názvem šablony u~složených
patternů).

Při opakovaném volání \verb|defrule| se stejným jménem pravidla dochází 
k~přepsání jeho definice.

K~zneplatnění definice pravidla slouží makro \verb|undefrule|, jehož jediným
parametrem je název pravidla.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Spouštění inferenčního mechanismu}
Jakmile jsou systému zadána inicializační fakta a pravidla, je třeba spustit
výpočet. Ten pak probíhá v~kolech, kde se střídají dvě akce. Nejdříve inferenční
machanismus zjistí, která pravidla mají splněné podmínky a jakým faktem je ta
která podmínka splněna. Následně je ze seznamu splněných pravidel (\emph{agendy}
vybráno pravidlo a toto je aktivováno. Po vyhodnocení aktivací pravidla se opět
aktualizuje seznam splněných pravidel atd.

Výpočet inferenčního mechanismu se spouští funkcí \verb|run| (bez parametrů).
Chceme-li výpočet sledovat po krocíh, můžeme použít funkci \verb|step| (též bez
parametrů), která vždy spustí jen jedno kolo výpočtu.

Dále je k~dispozici funkce \verb|halt|, která výpočet přeruší. Tuto funkci nemá
smysl používat samostatně, její volání je ale někdy vhodné zařadit do seznamu
aktivací některých pravidel. Tím signalizujeme, že jsou-li podmínky pravidla
splněny, dosáhli jsme, čeho jsme chtěli a výpočet může skončit.

\subsubsection{Strategie výběru pravidla k~aktivaci}
Výběr následujícího pravidla k~aktivaci je ovlivněn zvolenou strategií.
K~výběru strategie slouží makro \verb|set-strategy|, jehož jediným parametrem je
název kýžené strategie.

Kromě vestavěných strategií je možné definovat také strategie vlastní. To se
provádí makrem \verb|defstrategy|, jemuž předáme název nové strategie a
funkci, která z~agendy, již dostane parametrem vybere jednu z~aktivací a tu
vrátí. Definice strategií tedy mohou vypadat třeba takto:
\begin{verbatim}
(defstrategy fast-strategy #'first)
(defstrategy random
  (lambda (agenda)
    (nth (random (length agenda))
         (agenda))))
\end{verbatim}
O~vestavěných strategiích budu hovořit v~následující části textu.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Sledování změn prostředí}
Poslední věcí sloužící k~zefektivnění práce s~knihovnou je možnost sledovat
změny ve znalostní bazi či agendě. Sledovat je možno přidávání či ubíraní faktů
do a ze znalostní baze, definice a zneplatnění pravidel a změny v~agendě.

Sledování se zapíná makrem \verb|watch| a vypíná makrem \verb|unwatch|. Obě
makra berou očekávají jako parametr předmět sledování, tedy jeden ze symbolů
\verb|facts|, \verb|rules| či \verb|activations|.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Příklad práce s~knihovnou}
\input{ukazka.tex}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
